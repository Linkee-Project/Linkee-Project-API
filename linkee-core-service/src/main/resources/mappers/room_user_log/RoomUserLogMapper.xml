<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.linkee.linkeeapi.room_user_log.query.mapper.RoomUserLogMapper">

    <!-- 사용자별 퀴즈 풀이 이력 조회 쿼리
    - 특정 room_member_id(방에 참여 중인 사용자 ID)를 기준으로
      사용자가 푼 문제 기록(정답 여부 포함)을 모두 조회한다. -->
    <select id="findByRoomMemberId"
            resultType="com.linkee.linkeeapi.room_user_log.query.dto.response.RoomUserLogResponse">

        SELECT
            room_user_log_id,   -- 룸 유저 로그의 고유 식별자 (각 풀이 기록 ID)
            room_question_id,   -- 사용자가 푼 문제의 ID (tb_room_question 참조)
            room_member_id,     -- 방 내 사용자 ID (tb_room_member 참조)
            is_corrected        -- 해당 문제를 맞췄는지 여부 ('Y' 또는 'N')
        FROM
            tb_room_user_log    -- 퀴즈방 내 사용자별 문제 풀이 로그 테이블
        WHERE
            room_member_id = #{roomMemberId}  -- 특정 사용자의 로그만 조회
    </select>

    <!-- 방 단위 랭킹 조회(정답 수 기준 내림차순) -->
    <select id="findRankByRoomId"
            resultType="com.linkee.linkeeapi.room_user_log.query.dto.response.RoomUserRankResponse">
        <!-- 목적: 퀴즈방의 각 참가자별 정답 개수를 집계해 랭킹을 만든다 -->
        SELECT
        rm.room_member_id   AS roomMemberId,  -- 참가자 PK
        COUNT(rul.room_user_log_id) AS correctCount  -- 정답 개수
        FROM tb_room_member rm
        LEFT JOIN tb_room_user_log rul
        ON rm.room_member_id = rul.room_member_id
        AND rul.is_corrected = 'Y'
        WHERE rm.quiz_room_id = #{roomId}   -- 해당 방의 멤버만 대상
        GROUP BY rm.room_member_id
        ORDER BY correctCount DESC
    </select>

</mapper>

