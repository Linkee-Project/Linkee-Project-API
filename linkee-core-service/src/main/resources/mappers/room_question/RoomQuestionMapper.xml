<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.linkee.linkeeapi.room_question.query.mapper.RoomQuestionMapper">

    <!--
        [ResultMap 설명]
        - id: 이 resultMap을 식별하는 고유한 이름입니다.
        - type: 쿼리 결과를 매핑할 최종적인 객체 타입(DTO)을 지정합니다.
    -->
    <resultMap id="roomQuestionResponseResultMap" type="com.linkee.linkeeapi.room_question.query.dto.response.RoomQuestionResponse">
        <!-- <id>: PK 컬럼을 DTO의 필드에 매핑합니다. -->
        <id property="roomQuestionId" column="room_question_id"/>
        <!-- <result>: 일반 컬럼을 DTO의 필드에 매핑합니다. -->
        <result property="questionId" column="question_id"/>
        <result property="questionContent" column="question_question"/>

        <!--
            [collection 설명]
            - property: 메인 객체(RoomQuestionResponse)에서 리스트 형태를 가지는 필드명(options)을 지정합니다.
            - ofType: 리스트가 담을 객체의 타입(String)을 지정합니다.
            - select: 리스트를 채우기 위해 실행할 추가 쿼리의 id(findOptionsByQuestionId)를 지정합니다.
            - column: 메인 쿼리 결과 중, 추가 쿼리에 파라미터로 넘길 컬럼명(question_id)을 지정합니다.
            MyBatis는 findByRoomId 쿼리 결과의 각 row에 대해, 'question_id' 값을 findOptionsByQuestionId 쿼리에 넘겨 실행하고,
            그 결과(보기 목록)를 RoomQuestionResponse의 'options' 필드에 채워줍니다.
        -->
        <collection property="options" ofType="java.lang.String"
                    select="findOptionsByQuestionId" column="question_id"/>
    </resultMap>

    <!-- 메인 쿼리: 특정 퀴즈방에 속한 문제들의 기본 정보를 조회합니다. -->
    <select id="findByRoomId" resultMap="roomQuestionResponseResultMap">
        SELECT
            rq.room_question_id,
            q.question_id,
            q.question_question
        FROM
            tb_room_question rq
        JOIN
            tb_question q ON rq.question_id = q.question_id
        WHERE
            rq.quiz_room_id = #{roomId}
        ORDER BY
            rq.quiz_order ASC
    </select>

    <!-- 서브 쿼리: 특정 문제 ID에 해당하는 보기(option) 텍스트 목록을 조회합니다. -->
    <select id="findOptionsByQuestionId" resultType="java.lang.String">
        SELECT
            question_option_text
        FROM
            tb_question_option
        WHERE
            question_id = #{questionId}
        ORDER BY
            question_option_index ASC
    </select>

</mapper>