<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.linkee.linkeeapi.comment.query.mapper.CommentMapper">

    <resultMap id="CommentListMap" type="com.linkee.linkeeapi.comment.query.dto.CommentListResponseDto">
        <id     property="commentId"       column="comment_id"/>
        <result property="parentCommentId" column="parent_comment_id"/>
        <result property="questionId"      column="question_id"/>
        <result property="userId"          column="user_id"/>
        <result property="userNickname"    column="user_nickname"/>
        <result property="commentContent"  column="comment_content"/>
        <result property="isDeleted"       column="is_deleted"/>
        <result property="createdAt"       column="created_at"/>
        <result property="childCount"      column="child_count"/>
    </resultMap>

    <!-- 문제별 전체 댓글(부모+자식) 조회 -->
    <select id="findAllByQuestionIdWithUser" resultMap="CommentListMap">
        SELECT
        c.comment_id,
        c.parent_comment_id,
        c.question_id,
        c.user_id,
        u.user_nickname,
        c.comment_content,
        c.is_deleted,
        c.created_at,
        (
        SELECT COUNT(*)
        FROM tb_comment cc
        WHERE cc.parent_comment_id = c.comment_id
        AND cc.is_deleted = #{status}
        ) AS child_count
        FROM tb_comment c
        LEFT JOIN tb_user u ON u.user_id = c.user_id
        WHERE c.question_id = #{questionId}
        AND c.is_deleted = #{status}
        ORDER BY
        (c.parent_comment_id IS NULL) DESC,
        c.parent_comment_id ASC,
        c.comment_id ASC
    </select>

    <!-- 특정 부모의 자식(대댓글)만 조회 -->
    <select id="findChildCommentsByParentId" resultMap="CommentListMap">
        SELECT
        c.comment_id,
        c.parent_comment_id,
        c.question_id,
        c.user_id,
        u.user_nickname,
        c.comment_content,
        c.is_deleted,
        c.created_at,
        0 AS child_count
        FROM tb_comment c
        LEFT JOIN tb_user u ON u.user_id = c.user_id
        WHERE c.parent_comment_id = #{parentCommentId}
        AND c.is_deleted = #{status}
        ORDER BY c.comment_id ASC
    </select>

</mapper>
