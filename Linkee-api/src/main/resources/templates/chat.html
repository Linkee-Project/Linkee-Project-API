<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ë§í‚¤</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.6.1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; }
        #rooms { list-style: none; padding: 0; margin: 0; width: 300px; }
        #rooms li { padding: 8px; border: 1px solid #ccc; margin-bottom: 4px; cursor: pointer; display: flex; justify-content: space-between; }
        #rooms li:hover { background-color: #f0f0f0; }
        #rooms li.active { background-color: #d0f0d0; }
        #chat { border: 1px solid #ccc; height: 400px; overflow-y: scroll; padding: 10px; margin-top: 10px; width: 600px; }
        #message { width: 500px; }
        .system { color: gray; font-style: italic; }
        /* ì„ íƒ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .option-btn {
            margin: 4px;
            padding: 6px 12px;
            border: 1px solid #999;
            background-color: #f9f9f9;
            cursor: pointer;
            border-radius: 6px;
        }
        .option-btn.selected {
            background-color: #4CAF50;
            color: white;
            font-weight: bold;
        }
    </style>
</head>

<body>
<h2>ë§í‚¤</h2>

<div>
    JWT Token:
    <input type="text" id="token" placeholder="JWT ì…ë ¥" style="width: 400px;">
    <button onclick="connect()">ì—°ê²°</button>
</div>

<hr>

<h3>ìƒˆ ë°© ë§Œë“¤ê¸°</h3>
<input type="text" id="newRoomName" placeholder="ë°© ì´ë¦„ ì…ë ¥">

<div>
    <p><strong>ë°© íƒ€ì… ì„ íƒ:</strong></p>
    <button class="option-btn selected" id="btnChat" onclick="selectRoomType('CHAT')">CHAT</button>
    <button class="option-btn" id="btnGame" onclick="selectRoomType('GAME')">GAME</button>
</div>

<div>
    <p><strong>ê³µê°œ ì—¬ë¶€:</strong></p>
    <button class="option-btn selected" id="btnPublic" onclick="selectIsPrivate('N')">ê³µê°œ</button>
    <button class="option-btn" id="btnPrivate" onclick="selectIsPrivate('Y')">ë¹„ê³µê°œ</button>
</div>

<!-- ğŸ”¹ ë°© ì½”ë“œ (ë¹„ê³µê°œì¼ ë•Œë§Œ í‘œì‹œ) -->
<div id="roomCodeContainer" style="display:none;">
    <p><strong>ë¹„ê³µê°œ ë°© ì½”ë“œ ì…ë ¥:</strong></p>
    <input type="number" id="roomCode" placeholder="ì˜ˆ: 1234">
</div>

<!-- ğŸ”¹ ê²Œì„ë°© ì¸ì›ìˆ˜ (GAMEì¼ ë•Œë§Œ í‘œì‹œ) -->
<div id="capacityContainer" style="display:none;">
    <p><strong>ë°© ì¸ì› ìˆ˜ (ìµœëŒ€ 5ëª…):</strong></p>
    <input type="number" id="roomCapacity" min="1" max="5" value="2">
</div>

<button onclick="createRoom()">ë°© ë§Œë“¤ê¸°</button>

<h3>ë°© ëª©ë¡</h3>
<ul id="rooms"></ul>

<h3>ì±„íŒ…</h3>

<!-- âœ… QnA í‘œì‹œ ì˜ì—­ ì¶”ê°€ -->
<div id="qna-box">
    <p><strong>ğŸ§© í˜„ì¬ ë¬¸ì œ:</strong> <span id="current-question">-</span></p>
    <p id="answer-section"><strong>âœ… ì •ë‹µ:</strong> <span id="current-answer"></span></p>
    <button id="reveal-btn" onclick="revealAnswer()">ì •ë‹µ ê³µê°œ</button>
</div>

<div id="chat"></div>

<input type="text" id="message" placeholder="ë©”ì‹œì§€ ì…ë ¥">
<button onclick="sendMessage()">ì „ì†¡</button>
<button onclick="leaveRoom()">ë‚˜ê°€ê¸°</button>

<!-- âœ… QnA ë“±ë¡ ë²„íŠ¼ -->
<button onclick="createQuestion()">ë¬¸ì œ ë“±ë¡</button>

<script>
    let stompClient = null;
    let selectedRoomId = null;
    let currentSubscription = null;
    let token = null;

    // ë°© íƒ€ì… / ê³µê°œ ì—¬ë¶€ ê¸°ë³¸ê°’
    let selectedRoomType = 'CHAT';
    let selectedIsPrivate = 'N';

    // WebSocket ì—°ê²°
    function connect() {
        token = document.getElementById("token").value;
        const socket = new SockJS('http://localhost:8080/ws-chat');
        // const socket = new SockJS('http://192.168.2.49:8080/ws-chat');
        stompClient = Stomp.over(socket);
        stompClient.connect({'Authorization': token}, function(frame) {
            console.log('Connected: ' + frame);
            loadRooms();
            setInterval(loadRooms, 5000); // 5ì´ˆë§ˆë‹¤ ë°© ëª©ë¡ ê°±ì‹ 
        });
    }

    // ë°© ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° (ì•„ì´ì½˜ í‘œì‹œ + íƒ€ì…ë³„ ì •ë ¬)
    function loadRooms() {
        fetch('http://localhost:8080/chat/rooms', {
            // fetch('http://192.168.2.49:8080/chat/rooms', {
            headers: { 'Authorization': token }
        })
            .then(res => res.json())
            .then(data => {
                const ul = document.getElementById("rooms");
                ul.innerHTML = "";

                // âœ… CHATê³¼ GAMEìœ¼ë¡œ ë¶„ë¦¬
                const chatRooms = data.filter(r => r.chatRoomType === 'CHAT');
                const gameRooms = data.filter(r => r.chatRoomType === 'GAME');

                // âœ… ë°© ìƒì„± í•¨ìˆ˜ (ê³µí†µ)
                const createRoomItem = (room) => {
                    const li = document.createElement("li");
                    li.dataset.roomId = room.chatRoomId;

                    // ì•„ì´ì½˜ ì„¤ì • ğŸ® ğŸ”’
                    let icon = "";
                    if (room.chatRoomType === 'GAME') icon += "ğŸ® ";
                    if (room.isPrivate === 'Y') icon += "ğŸ”’ ";

                    li.innerHTML = `<span>${icon}${room.chatRoomName}</span><span>ì°¸ì—¬: ${room.joinedCount}</span>`;
                    li.onclick = () => enterRoom(room.chatRoomId);

                    if (selectedRoomId == room.chatRoomId)
                        li.classList.add("active");

                    return li;
                };

                // âœ… CHAT ë°© ë¬¶ìŒ
                if (chatRooms.length > 0) {
                    const chatHeader = document.createElement("h4");
                    chatHeader.textContent = "ğŸ’¬ ì±„íŒ…ë°© ëª©ë¡";
                    ul.appendChild(chatHeader);
                    chatRooms.forEach(room => ul.appendChild(createRoomItem(room)));
                }

                // âœ… GAME ë°© ë¬¶ìŒ
                if (gameRooms.length > 0) {
                    const gameHeader = document.createElement("h4");
                    gameHeader.textContent = "ğŸ® ê²Œì„ë°© ëª©ë¡";
                    ul.appendChild(gameHeader);
                    gameRooms.forEach(room => ul.appendChild(createRoomItem(room)));
                }
            });
    }

    // ë°© ì…ì¥
    function enterRoom(roomId) {
        selectedRoomId = roomId;
        document.getElementById("chat").innerHTML = "";
        document.getElementById("qna-box").style.display = "none"
        loadMessages();

        stompClient.send("/app/chat.join", {'roomId': roomId, 'Authorization': token}, {});
        subscribeRoom();
        highlightSelectedRoom();

        // âœ… í˜„ì¬ ë¬¸ì œ ì¡°íšŒ
        fetch(`http://localhost:8080/chat/qna/${roomId}/current`, {
            headers: { 'Authorization': token }
        })
            .then(res => res.json())
            .then(qna => {
                if (qna && qna.qnaQuestion) {
                    document.getElementById("qna-box").style.display = "block";
                    document.getElementById("current-question").textContent = qna.qnaQuestion;
                    if (qna.qnaAnswer) {
                        document.getElementById("answer-section").style.display = "block";
                        document.getElementById("current-answer").textContent = qna.qnaAnswer;
                    }
                }
            });
    }

    // ë©”ì‹œì§€ ë¶ˆëŸ¬ì˜¤ê¸°
    function loadMessages() {
        if(!selectedRoomId) return;
        fetch('http://localhost:8080/chat/rooms/' + selectedRoomId + '/messages', {
            // fetch('http://192.168.2.49:8080/chat/rooms/' + selectedRoomId + '/messages', {
            headers: { 'Authorization': token }
        })
            .then(res => res.json())
            .then(data => {
                const chatDiv = document.getElementById("chat");
                chatDiv.innerHTML = "";
                data.forEach(msg => {
                    if(msg.senderNickname === "SYSTEM"){
                        showMessage(msg.message, true);
                    } else {
                        showMessage(msg.senderNickname + ": " + msg.message, false);
                    }
                });
            });
    }

    function subscribeRoom() {
        if(currentSubscription) {
            currentSubscription.unsubscribe();
        }
        currentSubscription = stompClient.subscribe('/topic/chatroom/' + selectedRoomId, function(messageOutput) {
            const msg = JSON.parse(messageOutput.body);

            // âœ… QnA ë©”ì‹œì§€ ì²˜ë¦¬
            if (msg.type === "QNA_QUESTION") {
                document.getElementById("qna-box").style.display = "block";
                document.getElementById("current-question").textContent = msg.question;
                document.getElementById("answer-section").style.display = "none";
                showMessage("ğŸ§© ìƒˆ ë¬¸ì œê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!", true);
                return;
            }

            if (msg.type === "QNA_ANSWER") {
                document.getElementById("answer-section").style.display = "block";
                document.getElementById("current-answer").textContent = msg.answer;
                showMessage("âœ… ì •ë‹µì´ ê³µê°œë˜ì—ˆìŠµë‹ˆë‹¤!", true);
                return;
            }

            // ê¸°ì¡´ ë©”ì‹œì§€ ì²˜ë¦¬
            if(msg.senderNickname === "SYSTEM"){
                showMessage(msg.message, true);
            } else {
                showMessage(msg.senderNickname + ": " + msg.message, false);
            }
        });
    }

    // ë©”ì‹œì§€ ì „ì†¡
    function sendMessage() {
        if (!stompClient || !selectedRoomId) {
            alert("ë°©ì„ ì„ íƒí•˜ê³  ì—°ê²°í•˜ì„¸ìš”.");
            return;
        }
        const message = document.getElementById("message").value;
        if(!message) return;
        stompClient.send("/app/chat.send", {'Authorization': token},
            JSON.stringify({roomId: parseInt(selectedRoomId), message: message})
        );
        document.getElementById("message").value = "";
    }

    // âœ… ë¬¸ì œ ë“±ë¡
    function createQuestion() {
        if (!selectedRoomId) return alert("ë°©ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”.");
        const question = prompt("ë¬¸ì œë¥¼ ì…ë ¥í•˜ì„¸ìš”:");
        if (!question) return;
        const answer = prompt("ì •ë‹µì„ ì…ë ¥í•˜ì„¸ìš”:");
        if (!answer) return;

        fetch(`http://localhost:8080/chat/qna/${selectedRoomId}`, {
            method: "POST",
            headers: {
                "Authorization": token,
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                question: question,
                answer: answer,
                chatMemberId: 1 // âœ… ì‹¤ì œ chatMemberIdë¡œ ëŒ€ì²´ í•„ìš”
            })
        })
            .then(res => {
                if (!res.ok) throw new Error("ë“±ë¡ ì‹¤íŒ¨");
                alert("ë¬¸ì œ ë“±ë¡ ì™„ë£Œ!");
            })
            .catch(err => console.error(err));
    }

    // âœ… ì •ë‹µ ê³µê°œ
    function revealAnswer() {
        fetch(`http://localhost:8080/chat/qna/${selectedRoomId}/reveal`, {
            headers: { "Authorization": token }
        })
            .then(res => res.json())
            .then(qna => {
                document.getElementById("answer-section").style.display = "block";
                document.getElementById("current-answer").textContent = qna.qnaAnswer;
            });
    }

    // ğŸ”§ ë°© ìƒì„± ìˆ˜ì •ëœ ë¶€ë¶„
    function createRoom() {
        const roomName = document.getElementById("newRoomName").value.trim();
        if (!roomName) return alert("ë°© ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.");

        const roomCode = document.getElementById("roomCode").value ? parseInt(document.getElementById("roomCode").value) : null;
        const roomCapacity = document.getElementById("roomCapacity").value ? parseInt(document.getElementById("roomCapacity").value) : null;

        fetch('http://localhost:8080/chat/rooms', {
            // fetch('http://192.168.2.49:8080/chat/rooms?roomName=' + encodeURIComponent(roomName), {
            method: 'POST',
            headers: {
                'Authorization': token,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                chatRoomName: roomName,
                chatRoomType: selectedRoomType,
                isPrivate: selectedIsPrivate,
                roomCode: roomCode, // âœ… ì¶”ê°€
                roomCapacity: roomCapacity // âœ… ì¶”ê°€
            })
        })
            .then(res => {
                if (!res.ok) throw new Error("ë°© ìƒì„± ì‹¤íŒ¨");
                return res.json();
            })
            .then(() => {
                alert("ë°© ìƒì„± ì„±ê³µ!");
                loadRooms();
                document.getElementById("newRoomName").value = "";
                document.getElementById("roomCode").value = "";
            })
            .catch(err => console.error("ë°© ìƒì„± ì˜¤ë¥˜:", err));
    }

    // ë©”ì‹œì§€ í‘œì‹œ
    function showMessage(msg, isSystem=false) {
        const chatDiv = document.getElementById("chat");
        const p = document.createElement("p");
        if(isSystem) p.classList.add("system");
        p.textContent = msg;
        chatDiv.appendChild(p);
        chatDiv.scrollTop = chatDiv.scrollHeight;
    }

    // ì„ íƒëœ ë°© ê°•ì¡°
    function highlightSelectedRoom() {
        const lis = document.querySelectorAll("#rooms li");
        lis.forEach(li => {
            li.classList.remove("active");
            if(li.dataset.roomId == selectedRoomId)
                li.classList.add("active");
        });
    }

    // ë°© íƒ€ì… ì„ íƒ
    function selectRoomType(type) {
        selectedRoomType = type;
        document.getElementById("btnChat").classList.toggle("selected", type === 'CHAT');
        document.getElementById("btnGame").classList.toggle("selected", type === 'GAME');
        console.log("ì„ íƒëœ ë°© íƒ€ì…:", selectedRoomType);
    }

    // ê³µê°œ ì—¬ë¶€ ì„ íƒ
    function selectIsPrivate(flag) {
        selectedIsPrivate = flag;
        document.getElementById("btnPublic").classList.toggle("selected", flag === 'N');
        document.getElementById("btnPrivate").classList.toggle("selected", flag === 'Y');
        console.log("ì„ íƒëœ ê³µê°œ ì—¬ë¶€:", selectedIsPrivate);
    }

    // ë°© íƒ€ì… ì„ íƒ (ì¤‘ë³µ ì •ì˜)
    function selectRoomType(type) {
        selectedRoomType = type;
        document.getElementById("btnChat").classList.toggle("selected", type === 'CHAT');
        document.getElementById("btnGame").classList.toggle("selected", type === 'GAME');
        // ğŸ”¹ ê²Œì„ë°©ì´ë©´ ì¸ì›ìˆ˜ ì…ë ¥ ë³´ì´ê¸°
        document.getElementById("capacityContainer").style.display = (type === 'GAME') ? 'block' : 'none';
        console.log("ì„ íƒëœ ë°© íƒ€ì…:", selectedRoomType);
    }

    // ê³µê°œ ì—¬ë¶€ ì„ íƒ (ì¤‘ë³µ ì •ì˜)
    function selectIsPrivate(flag) {
        selectedIsPrivate = flag;
        document.getElementById("btnPublic").classList.toggle("selected", flag === 'N');
        document.getElementById("btnPrivate").classList.toggle("selected", flag === 'Y');
        // ğŸ”¹ ë¹„ê³µê°œ ì„ íƒ ì‹œ ë°©ì½”ë“œ ì…ë ¥ ë³´ì´ê¸°
        document.getElementById("roomCodeContainer").style.display = (flag === 'Y') ? 'block' : 'none';
        console.log("ì„ íƒëœ ê³µê°œ ì—¬ë¶€:", selectedIsPrivate);
    }

    // í˜ì´ì§€ ë– ë‚  ë•Œ í‡´ì¥ ì²˜ë¦¬
    window.addEventListener("beforeunload", function () {
        if(selectedRoomId && stompClient) {
            stompClient.send("/app/chat.leave", {'roomId': selectedRoomId, 'Authorization': token}, {});
        }
    });

    // ë°© ë‚˜ê°€ê¸° : chat_memberì—ì„œ ì‚­ì œ
    function leaveRoom() {
        if (!selectedRoomId || !stompClient) {
            alert("í˜„ì¬ ë“¤ì–´ê°€ ìˆëŠ” ë°©ì´ ì—†ìŠµë‹ˆë‹¤.");
            return;
        }

        // ì„œë²„ì— í‡´ì¥ ìš”ì²­ (ChatMember ì‚­ì œ)
        stompClient.send("/app/chat.leave", {'roomId': selectedRoomId, 'Authorization': token}, {});

        // êµ¬ë… í•´ì œ
        if (currentSubscription) {
            currentSubscription.unsubscribe();
            currentSubscription = null;
        }

        // UI ì´ˆê¸°í™”
        showMessage("ë°©ì„ ë‚˜ê°”ìŠµë‹ˆë‹¤.", true);
        selectedRoomId = null;
        document.getElementById("chat").innerHTML = "";
        highlightSelectedRoom();
        loadRooms(); // ë°© ëª©ë¡ ìƒˆë¡œê³ ì¹¨ (ì°¸ì—¬ì ìˆ˜ ì—…ë°ì´íŠ¸)
    }
</script>
</body>
</html>
