<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>채팅 테스트</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs/lib/stomp.min.js"></script>
    <style>
        #rooms li { cursor: pointer; }
        #rooms li.selected { font-weight: bold; color: blue; }
    </style>
</head>
<body>
<h1>채팅 테스트</h1>

<div>
    <input type="text" id="tokenInput" placeholder="JWT 토큰 입력">
    <button onclick="connect()">연결</button>
</div>

<div>
    <input type="text" id="roomName" placeholder="방 이름">
    <button onclick="createRoom()">방 생성</button>
</div>

<div>
    <h3>방 목록</h3>
    <ul id="rooms"></ul>
</div>

<div>
    <h3>메시지</h3>
    <div id="messages" style="border:1px solid #ccc; height:200px; overflow:auto;"></div>
    <input type="text" id="messageInput" placeholder="메시지 입력">
    <button onclick="sendMessage()">전송</button>
</div>

<script>
    let stompClient = null;
    let currentRoomId = null;

    function connect() {
        const token = document.getElementById("tokenInput").value.trim();
        if (!token) return alert("토큰 입력 필요");

        const socket = new SockJS('/ws');
        stompClient = Stomp.over(socket);

        stompClient.connect(
            { "Authorization": `Bearer ${token}` },
            frame => {
                console.log("Connected: " + frame);
                loadRooms();
            },
            error => {
                console.error("연결 실패", error);
                alert("연결 실패: 토큰 확인");
            }
        );
    }

    function loadRooms() {
        const token = document.getElementById("tokenInput").value.trim();
        fetch("/api/v1/chat/rooms", {
            headers: { "Authorization": `Bearer ${token}` }
        })
            .then(res => res.json())
            .then(data => {
                const roomsUl = document.getElementById("rooms");
                roomsUl.innerHTML = "";
                data.forEach(room => {
                    const li = document.createElement("li");
                    li.textContent = room.roomName + " (" + room.roomOwnerName + ")";
                    li.dataset.roomId = room.roomId;
                    li.onclick = () => joinRoom(room.roomId, li);
                    roomsUl.appendChild(li);
                });
            }).catch(console.error);
    }

    function createRoom() {
        const roomName = document.getElementById("roomName").value.trim();
        if (!roomName) return alert("방 이름 입력");

        const token = document.getElementById("tokenInput").value.trim();
        fetch("/api/v1/chat/room?roomName=" + encodeURIComponent(roomName), {
            method: "POST",
            headers: { "Authorization": `Bearer ${token}` }
        })
            .then(res => loadRooms())
            .catch(console.error);
    }

    function joinRoom(roomId, liElement) {
        document.querySelectorAll("#rooms li").forEach(li => li.classList.remove("selected"));
        liElement.classList.add("selected");
        currentRoomId = roomId;
        subscribeRoom(roomId);
    }

    function subscribeRoom(roomId) {
        if (!stompClient) return;
        if (stompClient.subscriptions) {
            Object.values(stompClient.subscriptions).forEach(sub => sub.unsubscribe());
        }

        stompClient.subscribe("/topic/chatroom/" + roomId, msg => {
            const message = JSON.parse(msg.body);
            showMessage(message.senderNickname, message.message);
        });
    }

    function showMessage(sender, message) {
        const messagesDiv = document.getElementById("messages");
        const div = document.createElement("div");
        div.textContent = sender + ": " + message;
        messagesDiv.appendChild(div);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    function sendMessage() {
        const msg = document.getElementById("messageInput").value.trim();
        if (!currentRoomId) return alert("방 선택");
        if (!msg) return;

        const token = document.getElementById("tokenInput").value.trim();
        stompClient.send("/app/message", { "Authorization": `Bearer ${token}` }, JSON.stringify({
            roomId: currentRoomId,
            message: msg
        }));
        document.getElementById("messageInput").value = "";
    }
</script>
</body>
</html>
